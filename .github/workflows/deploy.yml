name: Deploy Eclipse CRM Backend to VPS

on:
  push:
    branches: [master]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "18"

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 10

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build Strapi
        run: pnpm build

      - name: Deploy to VPS
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOSTNAME }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_PRIVATE_KEY }}
          port: 2222
          debug: true
          script: |
            echo "Starting deployment..."
            cd /var/www/eclipsestudiodashboard/backend/eclipse-crm-backend/
            echo "Current directory: $(pwd)"
            echo "Stashing local changes..."
            git stash
            echo "Pulling latest changes..."
            git pull origin master
            echo "Copying production environment file..."
            echo "${{ secrets.ENV_PRODUCTION }}" > .env
            echo "Converting .env to Unix format..."
            dos2unix .env
            echo "Checking .env file (without sensitive data)..."
            grep -v "PASSWORD" .env
            echo "Cleaning cache and build directories..."
            rm -rf .cache build dist
            echo "Installing dependencies with pnpm..."
            pnpm install
            echo "Verifying mysql2 installation..."
            pnpm list mysql2
            echo "Testing mysql2 connection capability..."
            node -e "try { require('mysql2'); console.log('mysql2 module loaded successfully'); } catch(e) { console.error('mysql2 module failed to load:', e.message); process.exit(1); }"
            echo "Building application..."
            pnpm build
            echo "Restarting application..."
            pm2 restart eclipse-crm-backend-strapi || pm2 start "pnpm start" --name "eclipse-crm-backend-strapi"
            echo "Waiting for application to start..."
            sleep 10
            echo "Checking application status..."
            pm2 status
            echo "Checking application logs for errors..."
            pm2 logs eclipse-crm-backend-strapi --lines 20 --nostream
            echo "Testing application health..."
            curl -f http://localhost:1338/api/clients?populate=* || echo "Health check failed (expected on first deploy)"
            echo "Deployment completed!"

      - name: Send Discord Notification
        if: success()
        uses: Ilshidur/action-discord@master
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
        with:
          args: "üöÄ Eclipse CRM Backend d√©ploy√© avec succ√®s !"
        continue-on-error: true

      - name: Send Discord notification on failure
        if: failure()
        uses: Ilshidur/action-discord@master
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
        with:
          args: "‚ùå √âchec du d√©ploiement Eclipse CRM Backend"
        continue-on-error: true

